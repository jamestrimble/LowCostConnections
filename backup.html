<!DOCTYPE html>
<!-- Map visualisation based on http://bl.ocks.org/mbostock/899711 -->
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <link href="datepicker/css/datepicker.css" rel="stylesheet">
  </head>
  <body>


      <div class="row">
        <div class="col-lg-9">
          <div id="map"></div>
        </div>
        <div class="col-lg-3">
          <h1>Low-Cost Connections</h1>
          
          <h3>1. Choose date</h3>
          <input id="date-picker" class="form-control" type="text" value="">
          <div id="origin-div">
            <h3>2. Click departure airport</h3>
            <p id="origin-p">Departing from <span id="origin-span"></span></p>
          </div>
          <div id="destination-div">
            <h3>3. Click destination</h3>
            <p id="destination-p">Destination: <span id="destination-span"></span></p>
            <div id="direct-flights">
                <p>Direct flights:</p>
                <div id="direct-flight-opts"></div>
            </div>

          </div>
          <div class="alert alert-warning" id="no-flights-found">
              No direct flights or flights with one connection were found.
          </div>
          <div id="connection-div">
            <h3>4. Click connecting airport</h3>
            <p id="connection-p">Connecting airport: <span id="connection-span"></span></p>
            <div class="connection-results">
                <p>Airlines for first leg:</p>
                <div id="flight-1-opts"></div>
            </div>
            <div class="connection-results">
                <p>Airlines for second leg:</p>
                <div id="flight-2-opts"></div>
            </div>
          </div>
          <p><a class="btn btn-primary" href="" role="button">Reset</a></p>
       </div>
     </div>

  
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="datepicker/js/bootstrap-datepicker.js"></script>

<script type="text/javascript">

var d = new Date();
$('#date-picker').val(1 + '/' + (d.getMonth()+2) + '/' + d.getFullYear());
$('#date-picker').datepicker({format: "d/m/yyyy"})

var mapStyle = [
  {
    "featureType": "landscape",
    "stylers": [
      { "visibility": "simplified" },
      { "lightness": 84 }
    ]
  },{
    "featureType": "poi",
    "stylers": [
      { "lightness": 77 }
    ]
  },{
    "featureType": "road",
    "stylers": [
      { "saturation": -90 },
      { "lightness": 74 }
    ]
  },{
    "elementType": "labels",
    "stylers": [
      { "lightness": 61 }
    ]
  },{
    "featureType": "water",
    "elementType": "geometry",
    "stylers": [
      { "lightness": 20 }
    ]
  },{
    "featureType": "administrative",
    "elementType": "geometry.stroke",
    "stylers": [
      { "lightness": 61 }
    ]
  }
];

// Create the Google Map…
var map = new google.maps.Map(d3.select("#map").node(), {
  zoom: 5,
  center: new google.maps.LatLng(47, 10),
  mapTypeId: google.maps.MapTypeId.ROADMAP,
  styles: mapStyle
  });


zIndex = 0;

// Load the airport data. When the data comes back, create an overlay.
d3.json("output/airports.json", function(data) {
  var routePlanner = new RoutePlanner(data);
  var overlay = new google.maps.OverlayView();

  // Add the container when the overlay is added to the map.
  overlay.onAdd = function() {

    var layer = d3.select(this.getPanes().floatPane).append("div")
        .attr("class", "airports");

    // Draw each marker as a separate SVG element.
    // We could use a single SVG, but what size would it have?
    overlay.draw = function() {
      var projection = this.getProjection(),
          padding = 10;

      var marker = layer.selectAll("svg")
          .data(d3.entries(data))
          .each(transform) // update existing markers
        .enter().append("svg")
          .each(transform)
          .attr("class", "marker")
          .style('z-index', ++zIndex)
          .attr('data-code',function(d) {return d.key});

      // Add a circle.
      marker.append("circle")
          .attr("r", 4.5)
          .attr("cx", padding)
          .attr("cy", padding)
          .attr('data-code',function(d) {return d.key})
          .on("mouseover", function() {
              d3.select(this.parentNode).classed("show-text", true);
              d3.select(this.parentNode).style('z-index', ++zIndex);
           })
          .on("mouseout", function() {
              d3.select(this.parentNode).classed("show-text", false);
           })
           .on("click", function(d) {
               routePlanner.click(d, this);
           });

      // Add a label.
      marker.append("text")
          .attr("x", padding + 7)
          .attr("y", padding)
          .attr("dy", ".31em")
          .text(function(d) { return d.value.name; })
          .attr('data-code',function(d) {return d.key});

      function transform(d) {
        d = new google.maps.LatLng(d.value.long_lat[1], d.value.long_lat[0]);
        d = projection.fromLatLngToDivPixel(d);
        return d3.select(this)
            .style("left", (d.x - padding) + "px")
            .style("top", (d.y - padding) + "px");
      }
    };
  };

  // Bind our overlay to the map…
  overlay.setMap(map);
});

function RoutePlanner(data) {
    this.waitingFor = "ORIGIN_CLICK";
    this.data = data;
}
RoutePlanner.prototype.click = function(d, circle) {
    console.log(d.key);
    if (this.waitingFor == "ORIGIN_CLICK") {
        this.originClick(d, circle);
    } else if (this.waitingFor == "DESTINATION_CLICK") {
        this.destinationClick(d, circle);
    } else if (this.waitingFor == "CONNECTION_CLICK") {
        this.connectionClick(d, circle);
    }
}
RoutePlanner.prototype.originClick = function(d, circle) {
    this.origin = d.key;
    d3.select(circle).classed("origin", true);
    d3.selectAll('text[data-code="' + d.key + '"]').classed("show-text", true);
    d3.select('#origin-span').text(d.value.name);
    this.waitingFor = "DESTINATION_CLICK";
    d3.select("#destination-div").style('visibility', 'visible');
    d3.select("#origin-p").style('visibility', 'visible');
}
RoutePlanner.prototype.destinationClick = function(d, circle) {
    d3.selectAll("circle").classed('muted', true);
    d3.select("#destination-p").style('visibility', 'visible');
    this.destination = d.key;
    d3.select(circle).classed("destination", true);
    d3.selectAll('text[data-code="' + d.key + '"]').classed("show-text", true);
    d3.select('#destination-span').text(d.value.name);
    this.waitingFor = "CONNECTION_CLICK";
    var routePlanner = this;
    routePlanner.routeDetails = {};
    nFlightsFound = 0;
    routePlanner.data[this.origin].routes.forEach(function(r) {
        if (r.code==routePlanner.destination) {
            nFlightsFound++;
            d3.select('#direct-flights').style('visibility', 'visible');
            d3.select("#direct-flight-opts").selectAll("p").remove();
            var newP = d3.select("#direct-flight-opts").append("p");
            console.log(' ' + r.airline);
            newP.append("a")
                .attr("href", routePlanner.getUrl(r.airline, routePlanner.origin, routePlanner.destination))
                .attr("target", "blank")
                .text(r.airline)            
        }
        routePlanner.data[r.code].routes.forEach(function(r2) {
            if (r2.code==routePlanner.destination) {
                nFlightsFound++;
                if (!routePlanner.routeDetails.hasOwnProperty(r.code)) {
                    routePlanner.routeDetails[r.code] = {firstLegOptions:[], secondLegOptions:[]};
                }
                routePlanner.routeDetails[r.code].firstLegOptions.push(r);
                if (routePlanner.routeDetails[r.code].secondLegOptions.indexOf(r2) == -1) {
                    routePlanner.routeDetails[r.code].secondLegOptions.push(r2);
                }
                
                console.log(routePlanner.data[r.code].name);
                
                d3.select('svg[data-code="' + r.code + '"]').style('z-index', ++zIndex);
                d3.select('text[data-code="' + r.code + '"]').classed('show-text', true);
                d3.select('circle[data-code="' + r.code + '"]').classed('connection', true);
                
            }
        });
    });
    if (nFlightsFound > 0) {
        d3.select("#connection-div").style('visibility', 'visible');    
    } else {
        d3.select("#no-flights-found").style('display', 'block');
    }
}
RoutePlanner.prototype.connectionClick = function(d, circle) {
    if (!this.routeDetails.hasOwnProperty(d.key)) {
        return;
    }
    this.connection = d.key;
    d3.select("#connection-p").style('visibility', 'visible');
    d3.select('#connection-span').text(d.value.name);
    d3.selectAll('.connection-results').style('visibility', 'visible');
    console.log(this.routeDetails[d.key]);
    for (var i=0; i<this.routeDetails[d.key].firstLegOptions.length; i++) {
        d3.select("#flight-1-opts").selectAll("p").remove();
        var newP = d3.select("#flight-1-opts").append("p");
        airline = this.routeDetails[d.key].firstLegOptions[i].airline;
        newP.append("a")
            .attr("href", this.getUrl(airline, this.origin, this.connection))
            .attr("target", "blank")
            .text(airline)
    }
    for (var i=0; i<this.routeDetails[d.key].secondLegOptions.length; i++) {
        d3.select("#flight-2-opts").selectAll("p").remove();
        var newP = d3.select("#flight-2-opts").append("p");
        newP.append("a")
            .attr("href", this.getUrl(airline, this.connection, this.destination))
            .attr("target", "blank")
            .text(this.routeDetails[d.key].secondLegOptions[i].airline)
    }
}

RoutePlanner.prototype.getUrl = function(airline, orig, dest) {
    if (airline == "easyJet") {
        return "http://www.easyjet.com/links.mvc?dep="
               + orig
               + "&dest="
               + dest
               + "&dd="
               + $('#date-picker').val()
               + "&apax=1&pid=www.easyjet.com&cpax=0&ipax=0&lang=EN"
               + "&isOneWay=on&searchFrom=SearchPod|/EN/&view=w";
    } else if (airline == "Ryanair") {
        return "http://www.ryanair.com";
    }
}
    </script>
  </body>

  
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">

<!-- Optional theme -->
<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">

<!-- Latest compiled and minified JavaScript -->
<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

<link rel="stylesheet" href="style.css">


</html>
